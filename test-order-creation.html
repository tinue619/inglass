<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ - Inglass CRM</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .btn {
            margin: 5px;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .status.info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤</h1>
        
        <div id="status" class="status info">
            üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...
        </div>
        
        <div>
            <button class="btn btn-primary" onclick="initializeSystem()">üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É</button>
            <button class="btn btn-success" onclick="createTestData()">üì¶ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
            <button class="btn btn-warning" onclick="testCreateOrder()">‚ûï –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞</button>
            <button class="btn btn-danger" onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>
        
        <div id="logs" class="test-log">
            –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥...
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª–∏ -->
    <script src="js/utils/constants.js"></script>
    <script src="js/utils/phoneUtils.js"></script>
    <script src="js/utils/orderUtils.js"></script>
    <script src="js/services/APIService.js"></script>
    <script src="js/modules/dataManager.js"></script>
    <script src="js/modules/modalModule.js"></script>
    <script src="js/modules/boardModule.js"></script>
    <script src="js/modules/defectModule.js"></script>

    <script>
        let currentUser = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logElement.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.className = `status ${type}`;
            statusElement.textContent = message;
            log(message, type);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã...\n';
        }
        
        async function initializeSystem() {
            try {
                updateStatus('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...', 'info');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                await DataManager.load();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                const admin = DataManager.getUsers().find(u => u.isAdmin);
                if (!admin) {
                    log('‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'error');
                    return;
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                DataManager.setCurrentUser(admin);
                currentUser = admin;
                
                log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
                log(`üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${admin.name} (–ê–¥–º–∏–Ω: ${admin.isAdmin})`, 'info');
                log(`üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${DataManager.getUsers().length}`, 'info');
                log(`‚öôÔ∏è –ü—Ä–æ—Ü–µ—Å—Å–æ–≤: ${DataManager.getProcesses().length}`, 'info');
                log(`üì¶ –ò–∑–¥–µ–ª–∏–π: ${DataManager.getProducts().length}`, 'info');
                log(`üìã –ó–∞–∫–∞–∑–æ–≤: ${DataManager.getOrders().length}`, 'info');
                
                updateStatus('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'error');
            }
        }
        
        async function createTestData() {
            try {
                updateStatus('üì¶ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                if (!currentUser) {
                    log('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É!', 'error');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã
                const processes = [
                    { id: Date.now() + 1, name: '–ü—Ä–∏–µ–º –∑–∞–∫–∞–∑–∞', order: 1 },
                    { id: Date.now() + 2, name: '–ó–∞–º–µ—Ä', order: 2 },
                    { id: Date.now() + 3, name: '–†–µ–∑–∫–∞', order: 3 },
                    { id: Date.now() + 4, name: '–£–ø–∞–∫–æ–≤–∫–∞', order: 4 }
                ];
                
                for (const process of processes) {
                    await DataManager.addProcess(process);
                    log(`‚úÖ –ü—Ä–æ—Ü–µ—Å—Å "${process.name}" —Å–æ–∑–¥–∞–Ω (ID: ${process.id})`, 'success');
                }
                
                // –°–æ–∑–¥–∞–µ–º –∏–∑–¥–µ–ª–∏—è
                const products = [
                    { 
                        id: Date.now() + 10, 
                        name: '–°—Ç–µ–∫–ª–æ', 
                        processes: processes.map(p => p.id)
                    },
                    { 
                        id: Date.now() + 11, 
                        name: '–ó–µ—Ä–∫–∞–ª–æ', 
                        processes: [processes[0].id, processes[2].id, processes[3].id]
                    }
                ];
                
                for (const product of products) {
                    await DataManager.addProduct(product);
                    log(`‚úÖ –ò–∑–¥–µ–ª–∏–µ "${product.name}" —Å–æ–∑–¥–∞–Ω–æ (ID: ${product.id})`, 'success');
                }
                
                updateStatus('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã', 'success');
                log(`üìä –ò—Ç–æ–≥–æ: ${processes.length} –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, ${products.length} –∏–∑–¥–µ–ª–∏–π`, 'info');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
                updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }
        
        async function testCreateOrder() {
            try {
                updateStatus('‚ûï –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞...', 'info');
                
                if (!currentUser) {
                    log('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É!', 'error');
                    return;
                }
                
                const products = DataManager.getProducts();
                if (products.length === 0) {
                    log('‚ùå –ù–µ—Ç –∏–∑–¥–µ–ª–∏–π! –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.', 'error');
                    return;
                }
                
                const product = products[0];
                log(`üì¶ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–¥–µ–ª–∏–µ: ${product.name} (ID: ${product.id})`, 'info');
                
                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑
                const testOrder = {
                    id: Date.now(),
                    number: OrderUtils.generateOrderNumber(),
                    productId: product.id,
                    customerName: '–¢–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç',
                    customerPhone: new Phone('+7 999 123 4567'),
                    currentProcessId: product.processes[0],
                    customFields: { '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π': '–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑' },
                    createdAt: new Date().toISOString(),
                    history: []
                };
                
                log(`üìù –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑: ${testOrder.number}`, 'info');
                log(`üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${testOrder.customerPhone.getFormatted()}`, 'info');
                log(`‚öôÔ∏è –ü–µ—Ä–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å: ${product.processes[0]}`, 'info');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑
                const addedOrder = await DataManager.addOrder(testOrder);
                
                if (addedOrder) {
                    log(`‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ! ID: ${addedOrder.id}`, 'success');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                    const firstProcess = DataManager.findProcess(product.processes[0]);
                    DataManager.addOrderHistoryEvent(testOrder.id, APP_CONSTANTS.EVENT_TYPES.CREATED, {
                        currentUser: currentUser,
                        toProcess: { id: product.processes[0], name: firstProcess?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å' }
                    });
                    
                    log(`üìù –°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏—Å—Ç–æ—Ä–∏—é`, 'info');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                    const savedOrder = DataManager.findOrder(testOrder.id);
                    if (savedOrder) {
                        log(`‚úÖ –ó–∞–∫–∞–∑ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö`, 'success');
                        log(`üìä –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–∞: ${savedOrder.history?.length || 0} —Å–æ–±—ã—Ç–∏–π`, 'info');
                        updateStatus('‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    } else {
                        log(`‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è!`, 'error');
                        updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞', 'error');
                    }
                    
                    log(`üìä –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ: ${DataManager.getOrders().length}`, 'info');
                } else {
                    log(`‚ùå –ó–∞–∫–∞–∑ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω`, 'error');
                    updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞', 'error');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: ${error.message}`, 'error');
                log(`üìù Stack trace: ${error.stack}`, 'error');
                updateStatus('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≥–æ—Ç–æ–≤—ã –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é', 'info');
        });
    </script>
</body>
</html>
