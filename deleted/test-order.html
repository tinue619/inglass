<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–ª—è order</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        .process-info { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–ª—è order —É –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</h1>
    
    <div>
        <button onclick="runOrderTest()">üß™ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç order</button>
        <button onclick="createTestProcess()">‚ûï –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å</button>
        <button onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>
    
    <div id="results"></div>
    
    <script src="js/utils/constants.js"></script>
    <script src="js/services/APIService.js"></script>
    <script src="js/modules/dataManager.js"></script>
    
    <script>
        const results = document.getElementById('results');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
            console.log(`[${type}] ${message}`);
        }
        
        function addProcessInfo(process) {
            const div = document.createElement('div');
            div.className = 'process-info';
            div.innerHTML = `
                <strong>–ü—Ä–æ—Ü–µ—Å—Å:</strong><br>
                ID: ${process.id}<br>
                Name: ${process.name}<br>
                Order: ${process.order} (${typeof process.order})<br>
                JSON: ${JSON.stringify(process, null, 2)}
            `;
            results.appendChild(div);
        }
        
        function clearResults() {
            results.innerHTML = '';
        }
        
        async function createTestProcess() {
            try {
                const testProcess = {
                    id: Date.now(),
                    name: `–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å ${Date.now()}`,
                    order: 99
                };
                
                addResult(`üîß –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Å order = ${testProcess.order}`, 'info');
                addProcessInfo(testProcess);
                
                await DataManager.addProcess(testProcess);
                addResult('‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –¥–æ–±–∞–≤–ª–µ–Ω –≤ DataManager', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è
                const foundProcess = DataManager.findProcess(testProcess.id);
                if (foundProcess) {
                    addResult(`‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–º—è—Ç–∏`, 'success');
                    addProcessInfo(foundProcess);
                } else {
                    addResult('‚ùå –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–º—è—Ç–∏!', 'error');
                }
                
                await runOrderTest();
                
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞: ${error.message}`, 'error');
            }
        }
        
        async function runOrderTest() {
            addResult('üöÄ –¢–ï–°–¢ –ü–û–õ–Ø ORDER', 'info');
            
            try {
                // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
                const processes = DataManager.getProcesses();
                addResult(`üìä –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: ${processes.length}`, 'info');
                
                processes.forEach((process, index) => {
                    addResult(`–ü—Ä–æ—Ü–µ—Å—Å ${index + 1}: ${process.name}, order = ${process.order} (${typeof process.order})`, 
                             process.order === undefined ? 'error' : 'success');
                    addProcessInfo(process);
                });
                
                // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage
                addResult('üíæ –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage...', 'info');
                const savedData = localStorage.getItem('crmData');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.processes && Array.isArray(parsed.processes)) {
                            addResult(`üíæ –í localStorage –Ω–∞–π–¥–µ–Ω–æ ${parsed.processes.length} –ø—Ä–æ—Ü–µ—Å—Å–æ–≤`, 'info');
                            parsed.processes.forEach((process, index) => {
                                addResult(`localStorage –ø—Ä–æ—Ü–µ—Å—Å ${index + 1}: ${process.name}, order = ${process.order} (${typeof process.order})`, 
                                         process.order === undefined ? 'error' : 'success');
                            });
                        }
                    } catch (parseError) {
                        addResult(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ localStorage: ${parseError.message}`, 'error');
                    }
                } else {
                    addResult('üì≠ localStorage –ø—É—Å—Ç', 'warning');
                }
                
                // –®–∞–≥ 3: –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                addResult('üîÑ –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏...', 'info');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
                const beforeReload = DataManager.getProcesses().map(p => ({ 
                    id: p.id, 
                    name: p.name, 
                    order: p.order 
                }));
                
                addResult(`üìù –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${beforeReload.length} –ø—Ä–æ—Ü–µ—Å—Å–æ–≤`, 'info');
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                DataManager.saveToCache();
                
                // –û—á–∏—â–∞–µ–º –ø–∞–º—è—Ç—å
                DataManager._data.processes = [];
                addResult('üóëÔ∏è –û—á–∏—â–µ–Ω–∞ –ø–∞–º—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤', 'warning');
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                await DataManager.load();
                addResult('üì• –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å
                const afterReload = DataManager.getProcesses();
                addResult(`üìä –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏: ${afterReload.length} –ø—Ä–æ—Ü–µ—Å—Å–æ–≤`, 'info');
                
                afterReload.forEach((process, index) => {
                    const originalProcess = beforeReload.find(p => p.id === process.id);
                    const orderMatches = originalProcess && originalProcess.order === process.order;
                    
                    addResult(`–ü—Ä–æ—Ü–µ—Å—Å ${index + 1}: ${process.name}`, 'info');
                    addResult(`  –ë—ã–ª–æ: order = ${originalProcess ? originalProcess.order : '–ù–ï–¢'} (${typeof originalProcess?.order})`, 'info');
                    addResult(`  –°—Ç–∞–ª–æ: order = ${process.order} (${typeof process.order})`, process.order === undefined ? 'error' : 'success');
                    addResult(`  –°–æ–≤–ø–∞–¥–∞–µ—Ç: ${orderMatches ? '‚úÖ' : '‚ùå'}`, orderMatches ? 'success' : 'error');
                    
                    addProcessInfo(process);
                });
                
                // –®–∞–≥ 4: –¢–µ—Å—Ç updateFromServer
                addResult('üåê –¢–µ—Å—Ç updateFromServer...', 'info');
                
                const testServerData = {
                    processes: [
                        { id: 9001, name: '–°–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å 1', order: 10 },
                        { id: 9002, name: '–°–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å 2', order: 20 },
                        { id: 9003, name: '–°–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –±–µ–∑ order' } // –ù–∞–º–µ—Ä–µ–Ω–Ω–æ –±–µ–∑ order
                    ],
                    users: DataManager.getUsers(),
                    products: DataManager.getProducts(),
                    orders: DataManager.getOrders()
                };
                
                addResult('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞...', 'info');
                const updateSuccess = DataManager.updateFromServer(testServerData);
                
                if (updateSuccess) {
                    addResult('‚úÖ updateFromServer –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                    
                    const serverProcesses = DataManager.getProcesses();
                    addResult(`üìä –ü–æ—Å–ª–µ updateFromServer: ${serverProcesses.length} –ø—Ä–æ—Ü–µ—Å—Å–æ–≤`, 'info');
                    
                    serverProcesses.forEach((process, index) => {
                        addResult(`–°–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å ${index + 1}: ${process.name}, order = ${process.order} (${typeof process.order})`, 
                                 process.order === undefined ? 'error' : 'success');
                        addProcessInfo(process);
                    });
                } else {
                    addResult('‚ùå updateFromServer –∑–∞–≤–µ—Ä—à–µ–Ω —Å –æ—à–∏–±–∫–æ–π', 'error');
                }
                
                addResult('üéâ –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù', 'success');
                
            } catch (error) {
                addResult(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`, 'error');
                console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ order:', error);
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => {
            addResult('üéØ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –ø–æ–ª—è order', 'info');
        }, 1000);
        
    </script>
</body>
</html>
