<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .data-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
    </style>
</head>
<body>
    <h1>üîÑ –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h1>
    
    <div class="data-info">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–≥—Ä—É–∑–∫–µ:</h3>
        <div id="loadingInfo">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>
    
    <div id="results"></div>
    
    <div style="margin: 20px 0;">
        <button class="btn-primary" onclick="testDataLoading()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö</button>
        <button class="btn-secondary" onclick="createTestData()">üìä –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
        <button class="btn-secondary" onclick="simulateRefresh()">üîÑ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
        <button class="btn-danger" onclick="clearAllData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
        <button class="btn-secondary" onclick="clearResults()">üìù –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>
    
    <script src="js/utils/constants.js"></script>
    <script src="js/services/APIService.js"></script>
    <script src="js/modules/dataManager.js"></script>
    <script>
        const results = document.getElementById('results');
        const loadingInfo = document.getElementById('loadingInfo');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        function updateLoadingInfo() {
            const processes = DataManager.getProcesses();
            const orders = DataManager.getOrders();
            const products = DataManager.getProducts();
            const users = DataManager.getUsers();
            
            loadingInfo.innerHTML = `
                <strong>–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:</strong><br>
                üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ${users ? users.length : 'undefined'}<br>
                ‚öôÔ∏è –ü—Ä–æ—Ü–µ—Å—Å—ã: ${processes ? processes.length : 'undefined'}<br>
                üì¶ –ò–∑–¥–µ–ª–∏—è: ${products ? products.length : 'undefined'}<br>
                üìã –ó–∞–∫–∞–∑—ã: ${orders ? orders.length : 'undefined'}<br>
                üåê –°–µ—Ä–≤–µ—Ä: ${APIService.isOnline ? 'üü¢ –û–Ω–ª–∞–π–Ω' : 'üî¥ –û—Ñ–ª–∞–π–Ω'}<br>
                üíæ localStorage: ${localStorage.getItem('crmData') ? '‚úÖ –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ' : '‚ùå –ü—É—Å—Ç–æ'}
            `;
        }
        
        function clearResults() {
            results.innerHTML = '';
        }
        
        async function testDataLoading() {
            addResult('üîß –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö...', 'info');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                updateLoadingInfo();
                addResult('üìä –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ', 'info');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                await DataManager.load();
                addResult('‚úÖ DataManager.load() –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
                const processes = DataManager.getProcesses();
                const orders = DataManager.getOrders();
                const products = DataManager.getProducts();
                const users = DataManager.getUsers();
                
                updateLoadingInfo();
                
                if (processes && orders && products && users) {
                    addResult('‚úÖ –í—Å–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                    addResult(`üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}`, 'info');
                    addResult(`‚öôÔ∏è –ü—Ä–æ—Ü–µ—Å—Å–æ–≤: ${processes.length}`, 'info');
                    addResult(`üì¶ –ò–∑–¥–µ–ª–∏–π: ${products.length}`, 'info');
                    addResult(`üìã –ó–∞–∫–∞–∑–æ–≤: ${orders.length}`, 'info');
                } else {
                    addResult('‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å!', 'error');
                    addResult(`–ü—Ä–æ—Ü–µ—Å—Å—ã: ${!!processes}, –ó–∞–∫–∞–∑—ã: ${!!orders}, –ò–∑–¥–µ–ª–∏—è: ${!!products}, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ${!!users}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, 'error');
            }
        }
        
        async function createTestData() {
            addResult('üì¶ –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...', 'info');
            
            try {
                await DataManager.createTestData();
                addResult('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã', 'success');
                updateLoadingInfo();
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
            }
        }
        
        async function simulateRefresh() {
            addResult('üîÑ –°–∏–º—É–ª–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...', 'warning');
            
            try {
                // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏ (—Å–∏–º—É–ª–∏—Ä—É–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É)
                DataManager._data = {
                    users: [APP_CONSTANTS.DEFAULTS.ADMIN_USER],
                    processes: [],
                    products: [],
                    orders: [],
                    currentUser: null
                };
                
                updateLoadingInfo();
                addResult('üóëÔ∏è –î–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏ –æ—á–∏—â–µ–Ω—ã (—Å–∏–º—É–ª—è—Ü–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)', 'warning');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω–æ–≤–æ
                await DataManager.load();
                addResult('üì• –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'info');
                
                updateLoadingInfo();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const processes = DataManager.getProcesses();
                const orders = DataManager.getOrders();
                
                if (processes && orders && processes.length > 0) {
                    addResult('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ "–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"', 'success');
                } else {
                    addResult('‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –ø–æ—Å–ª–µ "–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"!', 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏: ${error.message}`, 'error');
            }
        }
        
        async function clearAllData() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                return;
            }
            
            addResult('üóëÔ∏è –û—á–∏—â–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ...', 'warning');
            
            try {
                await DataManager.clearAll();
                localStorage.removeItem('crmData');
                addResult('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'warning');
                updateLoadingInfo();
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ${error.message}`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        setInterval(updateLoadingInfo, 2000);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            addResult('üöÄ –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –∑–∞–≥—Ä—É–∂–µ–Ω', 'info');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            updateLoadingInfo();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            setTimeout(async () => {
                await testDataLoading();
            }, 1000);
        });
        
        // –¢–µ—Å—Ç –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            console.log('üíæ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ localStorage');
        });
    </script>
</body>
</html>
