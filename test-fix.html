<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è undefined</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
    </style>
</head>
<body>
    <h1>üîß –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å undefined –¥–∞–Ω–Ω—ã–º–∏</h1>
    <p>–≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ–ª—å—à–µ –Ω–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è undefined –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏.</p>
    
    <div>
        <button class="btn-primary" onclick="runTest()">üß™ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
        <button class="btn-secondary" onclick="clearCache()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>
        <button class="btn-success" onclick="createTestDataAndTest()">üìä –°–æ–∑–¥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn-secondary" onclick="clearResults()">üìù –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>
    
    <div id="results"></div>
    
    <script src="js/utils/constants.js"></script>
    <script src="js/services/APIService.js"></script>
    <script src="js/modules/dataManager.js"></script>
    
    <script>
        const results = document.getElementById('results');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
            console.log(`[${type}] ${message}`);
        }
        
        function clearResults() {
            results.innerHTML = '';
        }
        
        function clearCache() {
            localStorage.removeItem('crmData');
            sessionStorage.clear();
            addResult('üóëÔ∏è –ö—ç—à –æ—á–∏—â–µ–Ω', 'warning');
        }
        
        async function createTestDataAndTest() {
            addResult('üìä –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...', 'info');
            
            try {
                await DataManager.createTestData();
                addResult('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã', 'success');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
                await runTest();
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
            }
        }
        
        async function runTest() {
            addResult('üöÄ –ù–ê–ß–ò–ù–ê–ï–ú –¢–ï–°–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø', 'info');
            
            try {
                // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ—Ç—Ç–µ—Ä–æ–≤
                addResult('–¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –≥–µ—Ç—Ç–µ—Ä—ã', 'info');
                
                const users = DataManager.getUsers();
                const processes = DataManager.getProcesses();
                const products = DataManager.getProducts();
                const orders = DataManager.getOrders();
                
                if (Array.isArray(users)) {
                    addResult(`‚úÖ getUsers() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ (${users.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤)`, 'success');
                } else {
                    addResult(`‚ùå getUsers() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ${typeof users}`, 'error');
                }
                
                if (Array.isArray(processes)) {
                    addResult(`‚úÖ getProcesses() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ (${processes.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤)`, 'success');
                } else {
                    addResult(`‚ùå getProcesses() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ${typeof processes}`, 'error');
                }
                
                if (Array.isArray(products)) {
                    addResult(`‚úÖ getProducts() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ (${products.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤)`, 'success');
                } else {
                    addResult(`‚ùå getProducts() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ${typeof products}`, 'error');
                }
                
                if (Array.isArray(orders)) {
                    addResult(`‚úÖ getOrders() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ (${orders.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤)`, 'success');
                } else {
                    addResult(`‚ùå getOrders() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ${typeof orders}`, 'error');
                }
                
                // –¢–µ—Å—Ç 2: –°–∏–º—É–ª—è—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                addResult('–¢–µ—Å—Ç 2: –°–∏–º—É–ª—è—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã', 'info');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const currentProcesses = DataManager.getProcesses().length;
                const currentOrders = DataManager.getOrders().length;
                
                addResult(`–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentProcesses} –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, ${currentOrders} –∑–∞–∫–∞–∑–æ–≤`, 'info');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∏–º–∏—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É)
                DataManager._data = {
                    users: [APP_CONSTANTS.DEFAULTS.ADMIN_USER],
                    processes: undefined, // –ù–∞–º–µ—Ä–µ–Ω–Ω–æ —Å—Ç–∞–≤–∏–º undefined
                    products: undefined,
                    orders: undefined,
                    currentUser: null
                };
                
                addResult('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ undefined)', 'warning');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≥–µ—Ç—Ç–µ—Ä—ã –∑–∞—â–∏—â–∞—é—Ç –æ—Ç undefined
                const protectedProcesses = DataManager.getProcesses();
                const protectedOrders = DataManager.getOrders();
                
                if (Array.isArray(protectedProcesses)) {
                    addResult('‚úÖ getProcesses() –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç undefined', 'success');
                } else {
                    addResult('‚ùå getProcesses() –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç undefined!', 'error');
                }
                
                if (Array.isArray(protectedOrders)) {
                    addResult('‚úÖ getOrders() –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç undefined', 'success');
                } else {
                    addResult('‚ùå getOrders() –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç undefined!', 'error');
                }
                
                // –¢–µ—Å—Ç 3: –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                addResult('–¢–µ—Å—Ç 3: –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö', 'info');
                
                await DataManager.load();
                
                const reloadedProcesses = DataManager.getProcesses();
                const reloadedOrders = DataManager.getOrders();
                
                if (Array.isArray(reloadedProcesses)) {
                    addResult(`‚úÖ –ü–æ—Å–ª–µ load() –ø—Ä–æ—Ü–µ—Å—Å—ã: –º–∞—Å—Å–∏–≤ (${reloadedProcesses.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤)`, 'success');
                } else {
                    addResult(`‚ùå –ü–æ—Å–ª–µ load() –ø—Ä–æ—Ü–µ—Å—Å—ã: ${typeof reloadedProcesses}`, 'error');
                }
                
                if (Array.isArray(reloadedOrders)) {
                    addResult(`‚úÖ –ü–æ—Å–ª–µ load() –∑–∞–∫–∞–∑—ã: –º–∞—Å—Å–∏–≤ (${reloadedOrders.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤)`, 'success');
                } else {
                    addResult(`‚ùå –ü–æ—Å–ª–µ load() –∑–∞–∫–∞–∑—ã: ${typeof reloadedOrders}`, 'error');
                }
                
                // –¢–µ—Å—Ç 4: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –≥–µ—Ç—Ç–µ—Ä–æ–≤
                addResult('–¢–µ—Å—Ç 4: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –≥–µ—Ç—Ç–µ—Ä–æ–≤', 'info');
                
                for (let i = 0; i < 5; i++) {
                    const testProcesses = DataManager.getProcesses();
                    const testOrders = DataManager.getOrders();
                    
                    if (!Array.isArray(testProcesses) || !Array.isArray(testOrders)) {
                        addResult(`‚ùå –í—ã–∑–æ–≤ ${i + 1}: –¥–∞–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã`, 'error');
                        break;
                    }
                    
                    if (i === 4) {
                        addResult('‚úÖ –í—Å–µ 5 –≤—ã–∑–æ–≤–æ–≤ –≥–µ—Ç—Ç–µ—Ä–æ–≤ —É—Å–ø–µ—à–Ω—ã', 'success');
                    }
                }
                
                // –¢–µ—Å—Ç 5: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
                addResult('–¢–µ—Å—Ç 5: –¢–µ—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞', 'info');
                
                const testServerData = {
                    users: [
                        { id: 1, name: '–¢–µ—Å—Ç–æ–≤—ã–π –∞–¥–º–∏–Ω', isAdmin: true },
                        { id: 2, name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', isAdmin: false }
                    ],
                    processes: [
                        { id: 1, name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å 1', order: 1 },
                        { id: 2, name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å 2', order: 2 }
                    ],
                    products: [
                        { id: 1, name: '–¢–µ—Å—Ç–æ–≤–æ–µ –∏–∑–¥–µ–ª–∏–µ', processes: [1, 2] }
                    ],
                    orders: [
                        { id: 1, number: 'TEST-001', customerName: '–¢–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç' }
                    ]
                };
                
                const updateSuccess = DataManager.updateFromServer(testServerData);
                
                if (updateSuccess) {
                    addResult('‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
                    
                    const updatedProcesses = DataManager.getProcesses();
                    const updatedOrders = DataManager.getOrders();
                    
                    addResult(`‚úÖ –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${updatedProcesses.length} –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, ${updatedOrders.length} –∑–∞–∫–∞–∑–æ–≤`, 'success');
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞', 'error');
                }
                
                addResult('üéâ –í–°–ï –¢–ï–°–¢–´ –ó–ê–í–ï–†–®–ï–ù–´!', 'success');
                
                // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                setTimeout(() => {
                    const finalProcesses = DataManager.getProcesses();
                    const finalOrders = DataManager.getOrders();
                    
                    if (Array.isArray(finalProcesses) && Array.isArray(finalOrders)) {
                        addResult('üèÜ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –î–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏!', 'success');
                    } else {
                        addResult('üí• –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –î–∞–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–¥–∏–ª–∏—Å—å!', 'error');
                    }
                }, 1000);
                
            } catch (error) {
                addResult(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`, 'error');
                console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞:', error);
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => {
            addResult('üéØ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é', 'info');
            addResult('üí° –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è', 'info');
        }, 1000);
        
    </script>
</body>
</html>
