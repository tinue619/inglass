<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ undefined –¥–∞–Ω–Ω—ã—Ö</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
        .error { background: #f8d7da; color: #721c24; }
        .warn { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å undefined –¥–∞–Ω–Ω—ã–º–∏</h1>
    
    <div>
        <button onclick="startDiagnostic()">üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
        <button onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
    </div>
    
    <div id="logs"></div>
    
    <script src="js/utils/constants.js"></script>
    <script src="js/services/APIService.js"></script>
    <script src="js/modules/dataManager.js"></script>
    
    <script>
        const logs = document.getElementById('logs');
        
        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `${new Date().toISOString()} - ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type}] ${message}`);
        }
        
        function clearLogs() {
            logs.innerHTML = '';
        }
        
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ DataManager._data
        const originalData = DataManager._data;
        
        // –°–æ–∑–¥–∞–µ–º Proxy –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
        DataManager._data = new Proxy(originalData, {
            get(target, prop) {
                const value = target[prop];
                addLog(`–ß–¢–ï–ù–ò–ï DataManager._data.${prop} = ${Array.isArray(value) ? `Array(${value.length})` : typeof value}`, 'info');
                return value;
            },
            
            set(target, prop, value) {
                const oldValue = target[prop];
                const oldType = Array.isArray(oldValue) ? `Array(${oldValue.length})` : typeof oldValue;
                const newType = Array.isArray(value) ? `Array(${value.length})` : typeof value;
                
                addLog(`–ó–ê–ü–ò–°–¨ DataManager._data.${prop}: ${oldType} ‚Üí ${newType}`, 'warn');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ undefined
                if (value === undefined) {
                    addLog(`‚ùå –û–ü–ê–°–ù–û! ${prop} —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è undefined!`, 'error');
                    console.trace(`DataManager._data.${prop} = undefined`);
                }
                
                target[prop] = value;
                return true;
            }
        });
        
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—ã–∑–æ–≤—ã –º–µ—Ç–æ–¥–æ–≤ DataManager
        const originalMethods = {
            load: DataManager.load,
            saveToCache: DataManager.saveToCache,
            getProcesses: DataManager.getProcesses,
            getOrders: DataManager.getOrders
        };
        
        DataManager.load = async function() {
            addLog('üîÑ DataManager.load() –ù–ê–ß–ê–õ–û', 'info');
            const result = await originalMethods.load.call(this);
            addLog(`üîÑ DataManager.load() –ö–û–ù–ï–¶. –ü—Ä–æ—Ü–µ—Å—Å—ã: ${this._data.processes?.length || 'undefined'}`, 'info');
            return result;
        };
        
        DataManager.saveToCache = function() {
            addLog(`üíæ DataManager.saveToCache(). –ü—Ä–æ—Ü–µ—Å—Å—ã: ${this._data.processes?.length || 'undefined'}`, 'info');
            return originalMethods.saveToCache.call(this);
        };
        
        DataManager.getProcesses = function() {
            const result = originalMethods.getProcesses.call(this);
            addLog(`üìä DataManager.getProcesses() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: ${Array.isArray(result) ? `Array(${result.length})` : typeof result}`, result === undefined ? 'error' : 'info');
            return result;
        };
        
        DataManager.getOrders = function() {
            const result = originalMethods.getOrders.call(this);
            addLog(`üìä DataManager.getOrders() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: ${Array.isArray(result) ? `Array(${result.length})` : typeof result}`, result === undefined ? 'error' : 'info');
            return result;
        };
        
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º APIService
        if (window.APIService) {
            const originalLoadFromServer = APIService.loadFromServer;
            APIService.loadFromServer = async function() {
                addLog('üåê APIService.loadFromServer() –ù–ê–ß–ê–õ–û', 'info');
                const result = await originalLoadFromServer.call(this);
                addLog(`üåê APIService.loadFromServer() –ö–û–ù–ï–¶. –†–µ–∑—É–ª—å—Ç–∞—Ç: ${result}`, 'info');
                return result;
            };
        }
        
        async function startDiagnostic() {
            addLog('üöÄ –ù–ê–ß–ò–ù–ê–ï–ú –î–ò–ê–ì–ù–û–°–¢–ò–ö–£', 'info');
            
            try {
                // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                addLog('–®–∞–≥ 1: –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ', 'info');
                addLog(`–ü—Ä–æ—Ü–µ—Å—Å—ã: ${DataManager._data.processes?.length || 'undefined'}`, 'info');
                addLog(`–ó–∞–∫–∞–∑—ã: ${DataManager._data.orders?.length || 'undefined'}`, 'info');
                
                // –®–∞–≥ 2: –û—á–∏—â–∞–µ–º localStorage –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞
                addLog('–®–∞–≥ 2: –û—á–∏—â–∞–µ–º localStorage', 'info');
                localStorage.removeItem('crmData');
                
                // –®–∞–≥ 3: –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ DataManager
                addLog('–®–∞–≥ 3: –°–±—Ä–∞—Å—ã–≤–∞–µ–º DataManager', 'info');
                DataManager._data.processes = [];
                DataManager._data.orders = [];
                
                // –®–∞–≥ 4: –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                addLog('–®–∞–≥ 4: –í—ã–∑—ã–≤–∞–µ–º DataManager.load()', 'info');
                await DataManager.load();
                
                // –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                addLog('–®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç', 'info');
                const processes = DataManager.getProcesses();
                const orders = DataManager.getOrders();
                
                addLog(`–ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã: ${Array.isArray(processes) ? `Array(${processes.length})` : typeof processes}`, processes === undefined ? 'error' : 'info');
                addLog(`–ò—Ç–æ–≥–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã: ${Array.isArray(orders) ? `Array(${orders.length})` : typeof orders}`, orders === undefined ? 'error' : 'info');
                
                // –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã (race condition)
                addLog('–®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã', 'info');
                setTimeout(() => {
                    const delayedProcesses = DataManager.getProcesses();
                    const delayedOrders = DataManager.getOrders();
                    
                    addLog(`–û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: ${Array.isArray(delayedProcesses) ? `Array(${delayedProcesses.length})` : typeof delayedProcesses}`, delayedProcesses === undefined ? 'error' : 'info');
                    addLog(`–û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–∫–∞–∑–æ–≤: ${Array.isArray(delayedOrders) ? `Array(${delayedOrders.length})` : typeof delayedOrders}`, delayedOrders === undefined ? 'error' : 'info');
                }, 2000);
                
            } catch (error) {
                addLog(`‚ùå –û–®–ò–ë–ö–ê –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò: ${error.message}`, 'error');
                console.error('–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:', error);
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(startDiagnostic, 1000);
        
    </script>
</body>
</html>
