<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –≤–µ—Ä—Å–∏–∏ CRM</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –≤–µ—Ä—Å–∏–∏ CRM</h1>
    <div id="results"></div>
    
    <div style="margin: 20px 0;">
        <button class="btn-primary" onclick="testServerConnection()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
        <button class="btn-secondary" onclick="testDataOperations()">üìä –¢–µ—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–π —Å –¥–∞–Ω–Ω—ã–º–∏</button>
        <button class="btn-secondary" onclick="testSync()">üîÑ –¢–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</button>
        <button class="btn-secondary" onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    
    <script src="js/utils/constants.js"></script>
    <script src="js/services/APIService.js"></script>
    <script src="js/modules/dataManager.js"></script>
    <script>
        const results = document.getElementById('results');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        function clearResults() {
            results.innerHTML = '';
        }
        
        async function testServerConnection() {
            addResult('üîß –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...', 'info');
            
            try {
                const available = await APIService.checkServerStatus();
                if (available) {
                    addResult('‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω!', 'success');
                    
                    const status = APIService.getConnectionStatus();
                    addResult(`üìä –°—Ç–∞—Ç—É—Å: –æ–Ω–ª–∞–π–Ω=${status.online}, –ø–æ–ø—ã—Ç–∫–∏=${status.retryCount}`, 'info');
                } else {
                    addResult('‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                    addResult('üí° –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω: start-server-db.bat', 'warning');
                }
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }
        
        async function testDataOperations() {
            addResult('üìä –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏...', 'info');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                await DataManager.load();
                addResult('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
                const users = DataManager.getUsers();
                const processes = DataManager.getProcesses();
                const products = DataManager.getProducts();
                const orders = DataManager.getOrders();
                
                addResult(`üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}`, 'info');
                addResult(`‚öôÔ∏è –ü—Ä–æ—Ü–µ—Å—Å–æ–≤: ${processes.length}`, 'info');
                addResult(`üì¶ –ò–∑–¥–µ–ª–∏–π: ${products.length}`, 'info');
                addResult(`üìã –ó–∞–∫–∞–∑–æ–≤: ${orders.length}`, 'info');
                
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
                const testProcess = {
                    id: Date.now(),
                    name: `–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å ${new Date().toLocaleTimeString()}`,
                    order: 99
                };
                
                await DataManager.addProcess(testProcess);
                addResult(`‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å: ${testProcess.name}`, 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å
                const updatedProcesses = DataManager.getProcesses();
                const foundProcess = updatedProcesses.find(p => p.id === testProcess.id);
                
                if (foundProcess) {
                    addResult('‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –Ω–∞–π–¥–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö', 'success');
                } else {
                    addResult('‚ùå –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö!', 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π: ${error.message}`, 'error');
            }
        }
        
        async function testSync() {
            addResult('üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é...', 'info');
            
            try {
                const success = await APIService.forceSync();
                if (success) {
                    addResult('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                } else {
                    addResult('‚ö†Ô∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏', 'warning');
                }
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            addResult('üöÄ –°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'info');
            addResult('üí° –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º', 'warning');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            setTimeout(() => {
                testServerConnection();
            }, 1000);
        });
    </script>
</body>
</html>
